{% extends "_base.html" %}

{% block title %}Analyze Your Skin - SkinCare AI{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin="" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white rounded-xl shadow-lg p-6 border border-primary/10">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Upload Your Skin Image</h2>
        
        <form method="POST" enctype="multipart/form-data" class="space-y-6" id="uploadForm">
            <div class="space-y-4">
                <div class="flex items-center justify-center w-full">
                    <label for="skin_image" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6" id="uploadPrompt">
                            <svg class="w-8 h-8 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                            </svg>
                            <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                            <p class="text-xs text-gray-500">PNG, JPG or JPEG (MAX. 10MB)</p>
                        </div>
                        <img id="imagePreview" class="hidden w-full h-full object-contain rounded-lg" alt="Preview">
                    </label>
                    <input id="skin_image" name="skin_image" type="file" class="hidden" accept="image/*" onchange="previewImage(this)">
                </div>
                
                <div id="previewControls" class="hidden flex justify-center space-x-4">
                    <button type="button" onclick="retakePhoto()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Retake Photo
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Analyze Image
                    </button>
                </div>
            </div>

            <!-- Location Services -->
            <div class="mt-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Enable Location Services (Optional)</h3>
                <p class="text-sm text-gray-500 mb-4">Allow location access to find nearby stores that sell recommended products.</p>
                <div class="flex items-center space-x-4">
                    <button type="button" onclick="getLocation()" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Enable Location
                    </button>
                    <span id="locationStatus" class="text-sm text-gray-500"></span>
                </div>
                <input type="hidden" name="latitude" id="latitude">
                <input type="hidden" name="longitude" id="longitude">
                <input type="hidden" name="radius" id="radius" value="5000">
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const previewControls = document.getElementById('previewControls');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                uploadPrompt.classList.add('hidden');
                previewControls.classList.remove('hidden');
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function retakePhoto() {
        const preview = document.getElementById('imagePreview');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const previewControls = document.getElementById('previewControls');
        const fileInput = document.getElementById('skin_image');
        
        preview.classList.add('hidden');
        uploadPrompt.classList.remove('hidden');
        previewControls.classList.add('hidden');
        fileInput.value = ''; // Clear the file input
    }

    function getLocation() {
        const locationStatus = document.getElementById('locationStatus');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        
        if (navigator.geolocation) {
            locationStatus.textContent = 'Getting location...';
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    latitudeInput.value = position.coords.latitude;
                    longitudeInput.value = position.coords.longitude;
                    locationStatus.textContent = 'Location enabled âœ“';
                    locationStatus.classList.add('text-green-600');
                },
                function(error) {
                    locationStatus.textContent = 'Location access denied';
                    locationStatus.classList.add('text-red-600');
                    console.error('Error getting location:', error);
                }
            );
        } else {
            locationStatus.textContent = 'Geolocation is not supported by your browser';
            locationStatus.classList.add('text-red-600');
        }
    }
</script>
{% endblock %}